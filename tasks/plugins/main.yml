---
- name: Configure Icinga2 custom commands
  include_tasks: commands_config/icinga2-commands-custom.yml
  when: >
    icinga2_custom_plugin_commands is defined
  tags:
    - configure
    - configure_commands 

- name: Install plugin prerequisites
  package:
    name: "{{ item }}"
    state: present
  loop: "{{ icinga2_package_prerequisites }}"
  tags:
    - configure

# TODO: Set only sudo access for plugins
- name: Enable passwordless sudo for Icinga2 user
  template:
    src: icinga2-sudoers.j2
    dest: "/etc/sudoers.d/{{ icinga2_user }}"
    validate: /usr/sbin/visudo -cf %s
  tags:
    - configure

- name: Include tasks for installing iostats
  include_tasks: plugins/icinga2_plugin_check_iostats.yml
  tags:
    - configure

- name: Include tasks for installing check_mysql
  include_tasks: plugins/icinga2_plugin_check_mysql_health.yml
  when: "'mysql_password' in icinga2_client_vars"
  tags:
    - configure

- name: Include tasks for installing check_rbl
  include_tasks: plugins/icinga2_plugin_check_rbl.yml
  when: "'rbl_hostname' in icinga2_client_vars"
  tags:
    - configure

- name: Include tasks for installing check_raid
  include_tasks: plugins/icinga2_plugin_check_raid.yml
  when: "'raid_enabled = true' in icinga2_client_vars"
  tags:
    - configure

- name: Include tasks for installing additional monitoring_plugins
  include_tasks: plugins/icinga2_additional_plugins.yml
  tags:
    - configure
...
